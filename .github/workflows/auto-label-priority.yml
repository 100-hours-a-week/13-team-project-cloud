name: Auto Label Priority

on:
  issues:
    types: [opened, edited]

jobs:
  label-priority:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Label priority
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const issueNumber = context.payload.issue.number;

            // 우선순위 섹션 파싱
            const priorityMatch = body.match(/### 우선순위\s*\n\s*(High|Medium|Low)/i);

            if (!priorityMatch) {
              console.log('우선순위를 찾을 수 없음');
              return;
            }

            const priority = priorityMatch[1].toLowerCase();
            const labelMap = {
              'high': '우선순위:높음',
              'medium': '우선순위:중간',
              'low': '우선순위:낮음'
            };

            const labelToAdd = labelMap[priority];
            if (!labelToAdd) return;

            // 기존 우선순위 라벨 제거
            const currentLabels = context.payload.issue.labels.map(l => l.name);
            const priorityLabels = ['우선순위:높음', '우선순위:중간', '우선순위:낮음'];

            for (const pl of priorityLabels) {
              if (currentLabels.includes(pl) && pl !== labelToAdd) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: pl
                }).catch(() => {});
              }
            }

            // 새 라벨 추가
            if (!currentLabels.includes(labelToAdd)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [labelToAdd]
              });
              console.log(`라벨 추가: ${labelToAdd}`);
            }
