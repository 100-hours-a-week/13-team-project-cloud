name: Auto Label Priority and Severity

on:
  issues:
    types: [opened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Label priority and severity
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const issueNumber = context.payload.issue.number;
            const currentLabels = context.payload.issue.labels.map(l => l.name);

            // 우선순위 파싱
            const priorityMatch = body.match(/### 우선순위\s*\n\s*(High|Medium|Low)/i);
            if (priorityMatch) {
              const priority = priorityMatch[1].toLowerCase();
              const priorityLabelMap = {
                'high': '우선순위:높음',
                'medium': '우선순위:중간',
                'low': '우선순위:낮음'
              };
              const priorityLabel = priorityLabelMap[priority];
              const priorityLabels = ['우선순위:높음', '우선순위:중간', '우선순위:낮음'];

              for (const pl of priorityLabels) {
                if (currentLabels.includes(pl) && pl !== priorityLabel) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: pl
                  }).catch(() => {});
                }
              }

              if (priorityLabel && !currentLabels.includes(priorityLabel)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [priorityLabel]
                });
                console.log(`우선순위 라벨 추가: ${priorityLabel}`);
              }
            }

            // 심각도 파싱
            const severityMatch = body.match(/### 심각도\s*\n\s*(Critical|High|Medium|Low)/i);
            if (severityMatch) {
              const severity = severityMatch[1].toLowerCase();
              const severityLabelMap = {
                'critical': '심각도:Critical',
                'high': '심각도:High',
                'medium': '심각도:Medium',
                'low': '심각도:Low'
              };
              const severityLabel = severityLabelMap[severity];
              const severityLabels = ['심각도:Critical', '심각도:High', '심각도:Medium', '심각도:Low'];

              for (const sl of severityLabels) {
                if (currentLabels.includes(sl) && sl !== severityLabel) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: sl
                  }).catch(() => {});
                }
              }

              if (severityLabel && !currentLabels.includes(severityLabel)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [severityLabel]
                });
                console.log(`심각도 라벨 추가: ${severityLabel}`);
              }
            }
