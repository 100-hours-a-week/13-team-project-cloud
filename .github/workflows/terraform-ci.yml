name: Terraform CI

on:
  pull_request:
    branches: [main]
    paths:
      - "v2-container/terraform/**"
      - ".github/workflows/terraform-ci.yml"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: terraform-ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  TF_WORKING_DIR: v2-container/terraform/environments/dev

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        working-directory: v2-container/terraform/environments/dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.0"

      - name: Format check
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Init (backend skip)
        run: terraform init -backend=false -input=false

      - name: Validate
        id: validate
        run: terraform validate -no-color

      - name: Post result to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fmt = '${{ steps.fmt.outcome }}';
            const val = '${{ steps.validate.outcome }}';
            const allPass = fmt === 'success' && val === 'success';
            const ok = (s) => s === 'success' ? 'âœ…' : 'âŒ';

            let mood;
            if (allPass) {
              const cheers = ['ê¹”ë”í•˜ë„¤ìš”! ë°”ë¡œ ë¨¸ì§€ ê°€ì‹œì£  ğŸš€', 'ì™„ë²½í•©ë‹ˆë‹¤ ğŸ‘¨â€ğŸ³ğŸ’‹', 'í„°ì§ ì—†ì´ í†µê³¼! ì˜¤ëŠ˜ ì ì‹¬ ë§›ìˆê²Œ ë“œì„¸ìš” ğŸš'];
              mood = cheers[Math.floor(Math.random() * cheers.length)];
            } else if (fmt !== 'success' && val === 'success') {
              const fmtFails = ['ì–´í—ˆ... í¬ë§· ì¢€ ì‹ ê²½ ì“°ì…”ì•¼ í•  ë“¯ ğŸ™ˆ', 'terraform fmt í•œ ë²ˆë§Œ ëŒë ¤ì£¼ì„¸ìš”... ì œë°œìš” ğŸ¥²', 'ë“¤ì—¬ì“°ê¸°ê°€ ì¶¤ì„ ì¶”ê³  ìˆì–´ìš” ğŸ’ƒ'];
              mood = fmtFails[Math.floor(Math.random() * fmtFails.length)];
            } else {
              const valFails = ['ì½”ë“œê°€ ë¹„ëª…ì„ ì§€ë¥´ê³  ìˆìŠµë‹ˆë‹¤ ğŸ”¥', 'validate ì‹¤íŒ¨... ì‹¬í˜¸í¡í•˜ê³  ë‹¤ì‹œ í•œë²ˆ ğŸ§˜', 'í„°ì¡ŒìŠµë‹ˆë‹¤ ì„ ìƒë‹˜ ğŸ’¥'];
              mood = valFails[Math.floor(Math.random() * valFails.length)];
            }

            const body = `<!-- terraform-ci -->
            ### ${allPass ? 'âœ¨' : 'ğŸš¨'} Terraform CI

            > ${mood}

            | Step | Result |
            |------|--------|
            | Format | ${ok(fmt)} \`${fmt}\` |
            | Validate | ${ok(val)} \`${val}\` |

            *Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('<!-- terraform-ci -->'));
            const params = {
              owner: context.repo.owner, repo: context.repo.repo, body,
            };
            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }

      - name: Fail on error
        if: steps.fmt.outcome == 'failure'
        run: exit 1

  cost:
    name: Infracost
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Cost breakdown
        run: |
          infracost breakdown \
            --path=${{ env.TF_WORKING_DIR }} \
            --format=json \
            --out-file=/tmp/infracost.json

      - name: Notify Discord
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          PR_NUM: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          TOTAL=$(jq -r '.totalMonthlyCost // "0"' /tmp/infracost.json)
          COUNT=$(jq '[.projects[].breakdown.resources[]] | length' /tmp/infracost.json)

          # ë‹¨ì¼ jqë¡œ ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¥˜ + embed JSON ìƒì„±
          jq -n --slurpfile data /tmp/infracost.json \
            --arg total "$TOTAL" \
            --arg count "$COUNT" \
            --arg pr_title "$PR_TITLE" \
            --arg run_url "$RUN_URL" \
            --arg pr_num "$PR_NUM" '

            # ë¦¬ì†ŒìŠ¤ ì¶”ì¶œ (ë¹„ìš© > 0)
            [$data[0].projects[].breakdown.resources[] |
              select(.monthlyCost != null and (.monthlyCost | tonumber) > 0)] as $resources |

            # ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
            def categorize:
              if (.name | startswith("aws_instance")) then "compute"
              elif (.name | startswith("aws_nat_gateway")) then "network"
              elif (.name | startswith("aws_lb")) then "network"
              elif (.name | startswith("aws_route53")) then "other"
              elif (.name | startswith("aws_cloudfront")) then "other"
              else "other"
              end;

            # ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í•‘
            (reduce $resources[] as $r (
              {"compute": [], "network": [], "other": []};
              .[$r | categorize] += [$r]
            )) as $groups |

            # ì¹´í…Œê³ ë¦¬ ì†Œê³„
            def cat_total(cat): [$groups[cat][] | .monthlyCost | tonumber] | add // 0 |
              . * 100 | round / 100;

            # ë¦¬ì†ŒìŠ¤ ìƒì„¸ í¬ë§·
            def format_resources(cat):
              [$groups[cat][] |
                "â–¸ " + (.name | split(".")[1:] | join(".")) + " â€” $" + .monthlyCost + "/ì›”\n" +
                ([
                  ((.costComponents // [])[], (.subresources // [])[].costComponents[]?) |
                  select(.monthlyCost != null and (.monthlyCost | tonumber) > 0) |
                  "  â”” " + .name + ": $" + .monthlyCost
                ] | join("\n"))
              ] | join("\n\n");

            (cat_total("compute") | tostring) as $ct |
            (cat_total("network") | tostring) as $nt |
            (cat_total("other") | tostring) as $ot |

            # ìš”ì•½ embed
            {embeds: ([
              {
                title: ("ğŸ’° ì›” ì˜ˆìƒ ë¹„ìš©: $" + $total),
                description: (
                  "**PR:** " + $pr_title + "\n" +
                  "**ë¦¬ì†ŒìŠ¤:** " + $count + "ê°œ\n" +
                  "[Actions ë¡œê·¸](" + $run_url + ")\n\n" +
                  "```\n" +
                  "Compute       $" + $ct + "\n" +
                  "Networking    $" + $nt + "\n" +
                  "ê¸°íƒ€           $" + $ot + "\n" +
                  "```"
                ),
                color: 3066993
              }
            ] + (
              if ($groups["compute"] | length) > 0 then [{
                title: ("ğŸ–¥ Compute â€” $" + $ct),
                description: ("```\n" + format_resources("compute") + "\n```"),
                color: 3447003
              }] else [] end
            ) + (
              if ($groups["network"] | length) > 0 then [{
                title: ("ğŸŒ Networking â€” $" + $nt),
                description: ("```\n" + format_resources("network") + "\n```"),
                color: 15105570
              }] else [] end
            ) + (
              if ($groups["other"] | length) > 0 then [{
                title: ("ğŸ“‹ ê¸°íƒ€ â€” $" + $ot),
                description: ("```\n" + format_resources("other") + "\n```"),
                color: 10070709
              }] else [] end
            ))}' | curl -sS -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-
