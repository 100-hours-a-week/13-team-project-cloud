name: Terraform CI

on:
  pull_request:
    branches: [develop, main]
    paths:
      - "v2-container/terraform/**"
      - ".github/workflows/terraform-ci.yml"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: terraform-ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  TF_WORKING_DIR: v2-container/terraform/environments/dev

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        working-directory: v2-container/terraform/environments/dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.0"

      - name: Format check
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Init (backend skip)
        run: terraform init -backend=false -input=false

      - name: Validate
        id: validate
        run: terraform validate -no-color

      - name: Post result to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fmt = '${{ steps.fmt.outcome }}';
            const val = '${{ steps.validate.outcome }}';
            const ok = (s) => s === 'success' ? '✅' : '❌';

            const body = `<!-- terraform-ci -->
            ### Terraform CI

            | Step | Result |
            |------|--------|
            | Format | ${ok(fmt)} \`${fmt}\` |
            | Validate | ${ok(val)} \`${val}\` |

            *Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('<!-- terraform-ci -->'));
            const params = {
              owner: context.repo.owner, repo: context.repo.repo, body,
            };
            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }

      - name: Fail on error
        if: steps.fmt.outcome == 'failure'
        run: exit 1

  cost:
    name: Infracost
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Cost breakdown
        run: |
          infracost breakdown \
            --path=${{ env.TF_WORKING_DIR }} \
            --format=json \
            --out-file=/tmp/infracost.json

      - name: Post cost to PR
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost.json
          behavior: update
