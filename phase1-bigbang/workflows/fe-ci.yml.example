# =============================================================================
# React + Vite + TypeScript Frontend CI Pipeline
# =============================================================================
# 트리거: PR 생성/업데이트 시 실행
# 순서: Lint → Build → Test → Artifact Upload
# =============================================================================

name: Frontend CI

on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Stage 1: Lint (코드 스타일 + 버그 검사)
  # ---------------------------------------------------------------------------
  # 목적: 빠른 피드백을 위해 코드 스타일 오류를 가장 먼저 검출
  # 도구: ESLint
  # 검사 내용: 문법 오류, React 규칙, 접근성(a11y)
  # ===========================================================================
  lint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # npm 의존성 캐시 - 설치 속도 향상
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Upload ESLint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Stage 2: Build (빌드)
  # ---------------------------------------------------------------------------
  # 목적: TypeScript 컴파일 및 번들링 검증
  # 실패 시 의미: TypeScript 오류, import 누락, 빌드 실패
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

  # ===========================================================================
  # Stage 3: Test (테스트)
  # ---------------------------------------------------------------------------
  # 목적: 핵심 컴포넌트 및 비즈니스 로직 검증
  # 구성:
  #   - 단위 테스트: Vitest (개별 함수, 커스텀 Hook)
  #   - 통합 테스트: Vitest + React Testing Library (컴포넌트 흐름)
  #   - 커버리지: 핵심 컴포넌트 전용
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Run Tests with Coverage
        run: npm run test:coverage

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            test-results/
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Stage 4: Artifact Upload (산출물 업로드)
  # ---------------------------------------------------------------------------
  # 목적: 빌드 결과물 보관 (리뷰어 확인 및 추후 디버깅)
  # 저장소: GitHub Actions Artifact (30일 보관)
  # ===========================================================================
  artifact:
    name: Build Artifact
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Build for Production
        run: npm run build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 30